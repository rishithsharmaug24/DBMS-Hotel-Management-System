{% extends "base.html" %}

{% block title %}Booking Details - Hotel Management System{% endblock %}

{% block page_icon %}<i class="fas fa-file-alt"></i>{% endblock %}
{% block page_title %}Booking Details{% endblock %}
{% block page_subtitle %}
  Complete booking information and management
{% endblock %}

{% block breadcrumb %}
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
    <li class="breadcrumb-item"><a href="/bookings">Bookings</a></li>
    <li class="breadcrumb-item active">Booking #{{ booking.booking_id }}</li>
  </ol>
{% endblock %}

{% block content %}

{% if booking %}

<!-- Success/Error Messages -->
{% if session.get('success_message') %}
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="fas fa-check-circle"></i> {{ session.get('success_message') }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
{% endif %}

<!-- Booking Header -->
<div class="card shadow mb-4">
  <div class="card-body">
    <div class="row align-items-center">
      <div class="col-md-6">
        <h2 class="mb-2">Booking #{{ booking.booking_id }}</h2>
        <p class="text-muted mb-0">
          Created: {{ booking.created_at.strftime('%d %b %Y, %H:%M') if booking.created_at else 'N/A' }}
        </p>
      </div>
      <div class="col-md-6 text-end">
        {% if booking.status == 'Confirmed' %}
          <span class="badge bg-success fs-5">Confirmed</span>
        {% elif booking.status == 'Checked-In' %}
          <span class="badge bg-info fs-5">Checked-In</span>
        {% elif booking.status == 'Checked-Out' %}
          <span class="badge bg-secondary fs-5">Checked-Out</span>
        {% elif booking.status == 'Cancelled' %}
          <span class="badge bg-danger fs-5">Cancelled</span>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="row">

  <!-- Left Column: Booking Information -->
  <div class="col-lg-8">

    <!-- Guest Information -->
    <div class="card shadow mb-4">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="fas fa-user"></i> Guest Information</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label text-muted">Guest Name</label>
            <p class="h6">
              <a href="/guests/{{ booking.guest_id }}">{{ booking.guest_name }}</a>
            </p>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label text-muted">Guest ID</label>
            <p class="h6">#{{ booking.guest_id }}</p>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label text-muted">Email</label>
            <p class="h6">
              <a href="mailto:{{ booking.guest_email }}">{{ booking.guest_email }}</a>
            </p>
          </div>
          <div class="col-md-6 mb-0">
            <label class="form-label text-muted">Phone</label>
            <p class="h6">
              <a href="tel:{{ booking.guest_phone }}">{{ booking.guest_phone }}</a>
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Room Information -->
    <div class="card shadow mb-4">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0"><i class="fas fa-door-open"></i> Room Information</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label text-muted">Room Number</label>
            <p class="h6">
              <a href="/rooms/{{ booking.room_id }}">Room {{ booking.room_number }}</a>
            </p>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label text-muted">Room Type</label>
            <p class="h6"><span class="badge bg-info">{{ booking.room_type }}</span></p>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label text-muted">Price per Night</label>
            <p class="h6">₹{{ booking.price_per_night }}</p>
          </div>
          <div class="col-md-6 mb-0">
            <label class="form-label text-muted">Room Status</label>
            <p class="h6">
              {% if booking.status == 'Checked-In' %}
                <span class="badge bg-warning">Occupied</span>
              {% else %}
                <span class="badge bg-success">Available</span>
              {% endif %}
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Booking Details -->
    <div class="card shadow mb-4">
      <div class="card-header bg-info text-white">
        <h5 class="mb-0"><i class="fas fa-calendar-alt"></i> Booking Details</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label text-muted">Check-in Date</label>
            <p class="h6">
              <i class="fas fa-calendar-plus text-success"></i> 
              {{ booking.check_in_date.strftime('%d %b %Y') }}
            </p>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label text-muted">Check-out Date</label>
            <p class="h6">
              <i class="fas fa-calendar-minus text-danger"></i> 
              {{ booking.check_out_date.strftime('%d %b %Y') }}
            </p>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label text-muted">Total Nights</label>
            <p class="h6">{{ booking.total_nights }} night(s)</p>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label text-muted">Number of Guests</label>
            <p class="h6">
              {{ booking.num_adults or 1 }} Adult(s)
              {% if booking.num_children %}
                + {{ booking.num_children }} Child(ren)
              {% endif %}
            </p>
          </div>
          {% if booking.special_requests %}
            <div class="col-12 mb-0">
              <label class="form-label text-muted">Special Requests</label>
              <p class="h6">{{ booking.special_requests }}</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Payment Information -->
    <div class="card shadow mb-4">
      <div class="card-header bg-warning text-dark">
        <h5 class="mb-0"><i class="fas fa-credit-card"></i> Payment Information</h5>
      </div>
      <div class="card-body">
        {% if payments %}
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Method</th>
                  <th>Amount</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                {% for payment in payments %}
                  <tr>
                    <td>{{ payment.payment_date.strftime('%d %b %Y') }}</td>
                    <td>{{ payment.payment_method }}</td>
                    <td>₹{{ payment.amount }}</td>
                    <td>
                      {% if payment.status == 'Paid' %}
                        <span class="badge bg-success">Paid</span>
                      {% else %}
                        <span class="badge bg-warning">Pending</span>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted text-center mb-0">No payments recorded yet</p>
        {% endif %}
      </div>
    </div>

    <!-- Services Used -->
    {% if services %}
    <div class="card shadow mb-4">
      <div class="card-header bg-secondary text-white">
        <h5 class="mb-0"><i class="fas fa-concierge-bell"></i> Services Used</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Service</th>
                <th>Quantity</th>
                <th>Price</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody>
              {% for service in services %}
                <tr>
                  <td>{{ service.service_name }}</td>
                  <td>{{ service.quantity }}</td>
                  <td>₹{{ service.price }}</td>
                  <td>₹{{ service.total }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% endif %}

  </div>

  <!-- Right Column: Actions & Summary -->
  <div class="col-lg-4">

    <!-- Quick Actions -->
    <div class="card shadow mb-4">
      <div class="card-header bg-secondary text-white">
        <h5 class="mb-0"><i class="fas fa-cogs"></i> Quick Actions</h5>
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          {% if booking.status == 'Confirmed' %}
            <button class="btn btn-success" onclick="checkIn()">
              <i class="fas fa-sign-in-alt"></i> Check-in Guest
            </button>
            <a href="/bookings/{{ booking.booking_id }}/modify" class="btn btn-warning">
              <i class="fas fa-edit"></i> Modify Booking
            </a>
            <a href="/bookings/{{ booking.booking_id }}/cancel" class="btn btn-danger">
              <i class="fas fa-times"></i> Cancel Booking
            </a>
          {% elif booking.status == 'Checked-In' %}
            <button class="btn btn-primary" onclick="checkout()">
              <i class="fas fa-sign-out-alt"></i> Check-out Guest
            </button>
            <a href="/bills/generate/{{ booking.booking_id }}" class="btn btn-warning">
              <i class="fas fa-file-invoice"></i> Generate Bill
            </a>
          {% elif booking.status == 'Checked-Out' %}
            <a href="/bills/{{ booking.booking_id }}" class="btn btn-info">
              <i class="fas fa-receipt"></i> View Bill
            </a>
          {% endif %}
          
          <button class="btn btn-outline-secondary" onclick="window.print()">
            <i class="fas fa-print"></i> Print Details
          </button>
          <a href="/bookings" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to List
          </a>
        </div>
      </div>
    </div>

    <!-- Billing Summary -->
    <div class="card shadow">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0"><i class="fas fa-calculator"></i> Billing Summary</h5>
      </div>
      <div class="card-body">
        <div class="mb-2">
          <div class="d-flex justify-content-between">
            <span>Room Charges:</span>
            <strong>₹{{ booking.room_charges or 0 }}</strong>
          </div>
        </div>
        <div class="mb-2">
          <div class="d-flex justify-content-between">
            <span>Service Charges:</span>
            <strong>₹{{ booking.service_charges or 0 }}</strong>
          </div>
        </div>
        <hr>
        <div class="mb-2">
          <div class="d-flex justify-content-between">
            <h5>Total Amount:</h5>
            <h5 class="text-success">₹{{ booking.total_amount or 0 }}</h5>
          </div>
        </div>
        <div class="mb-2">
          <div class="d-flex justify-content-between">
            <span>Amount Paid:</span>
            <strong class="text-success">₹{{ booking.amount_paid or 0 }}</strong>
          </div>
        </div>
        <div class="mb-0">
          <div class="d-flex justify-content-between">
            <span>Balance Due:</span>
            <strong class="text-danger">₹{{ (booking.total_amount or 0) - (booking.amount_paid or 0) }}</strong>
          </div>
        </div>
      </div>
    </div>

  </div>

</div>

{% else %}

<!-- Booking Not Found -->
<div class="alert alert-danger" role="alert">
  <h4 class="alert-heading"><i class="fas fa-exclamation-circle"></i> Booking Not Found</h4>
  <p>The booking you're looking for doesn't exist.</p>
  <hr>
  <p class="mb-0">
    <a href="/bookings" class="btn btn-sm btn-outline-primary">
      <i class="fas fa-arrow-left"></i> Back to Bookings
    </a>
  </p>
</div>

{% endif %}

{% endblock %}

{% block extra_js %}
<script>
  function checkIn() {
    if (confirm('Check-in this guest now?')) {
      fetch('/api/bookings/{{ booking.booking_id }}/checkin', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Guest checked in successfully');
          location.reload();
        } else {
          alert('Error: ' + data.error);
        }
      });
    }
  }

  function checkout() {
    if (confirm('Proceed to check-out and generate final bill?')) {
      window.location.href = '/bills/generate/{{ booking.booking_id }}';
    }
  }

  // Auto-dismiss alerts
  setTimeout(() => {
    document.querySelectorAll('.alert').forEach(alert => {
      alert.style.display = 'none';
    });
  }, 5000);
</script>
{% endblock %}
