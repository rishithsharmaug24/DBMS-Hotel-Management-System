{% extends "base.html" %}

{% block title %}Room Status Dashboard - Hotel Management System{% endblock %}

{% block page_icon %}<i class="fas fa-layer-group"></i>{% endblock %}
{% block page_title %}Room Status Dashboard{% endblock %}
{% block page_subtitle %}
  Real-time occupancy and room status overview
{% endblock %}

{% block breadcrumb %}
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
    <li class="breadcrumb-item active">Room Status</li>
  </ol>
{% endblock %}

{% block content %}

<!-- Status Overview Cards -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card text-center shadow-sm">
      <div class="card-body">
        <h6 class="text-muted mb-2"><i class="fas fa-door-open"></i> Total Rooms</h6>
        <h2 class="text-primary">{{ total_rooms or '0' }}</h2>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center shadow-sm">
      <div class="card-body">
        <h6 class="text-muted mb-2"><i class="fas fa-check-circle"></i> Available</h6>
        <h2 class="text-success">{{ available_rooms or '0' }}</h2>
        <small class="text-muted">{{ occupancy_pct or '0' }}% Occupied</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center shadow-sm">
      <div class="card-body">
        <h6 class="text-muted mb-2"><i class="fas fa-door-closed"></i> Booked</h6>
        <h2 class="text-warning">{{ booked_rooms or '0' }}</h2>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center shadow-sm">
      <div class="card-body">
        <h6 class="text-muted mb-2"><i class="fas fa-tools"></i> Maintenance</h6>
        <h2 class="text-danger">{{ maintenance_rooms or '0' }}</h2>
      </div>
    </div>
  </div>
</div>

<!-- Quick Actions & Filters -->
<div class="card shadow mb-4">
  <div class="card-body">
    <div class="row align-items-center">
      <div class="col-md-6">
        <h6 class="mb-3">Quick Filters:</h6>
        <div class="d-flex flex-wrap gap-2">
          <button class="btn btn-sm btn-outline-primary active" onclick="filterStatus('all')" id="filterAll">
            <i class="fas fa-list"></i> All Rooms
          </button>
          <button class="btn btn-sm btn-outline-success" onclick="filterStatus('Available')" id="filterAvailable">
            <i class="fas fa-check-circle"></i> Available
          </button>
          <button class="btn btn-sm btn-outline-warning" onclick="filterStatus('Booked')" id="filterBooked">
            <i class="fas fa-door-closed"></i> Booked
          </button>
          <button class="btn btn-sm btn-outline-danger" onclick="filterStatus('Maintenance')" id="filterMaintenance">
            <i class="fas fa-tools"></i> Maintenance
          </button>
        </div>
      </div>
      <div class="col-md-6 text-end">
        <label class="form-label mb-2">Display By:</label>
        <div class="btn-group btn-group-sm" role="group">
          <button type="button" class="btn btn-outline-secondary active" onclick="setViewMode('grid')">
            <i class="fas fa-th"></i> Grid
          </button>
          <button type="button" class="btn btn-outline-secondary" onclick="setViewMode('floor')">
            <i class="fas fa-building"></i> Floor
          </button>
          <button type="button" class="btn btn-outline-secondary" onclick="setViewMode('table')">
            <i class="fas fa-table"></i> Table
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Grid View (Default) -->
<div id="gridView">
  <div class="row" id="roomGridContainer">
    {% if rooms %}
      {% for room in rooms %}
        <div class="col-lg-3 col-md-4 col-sm-6 mb-3 room-status-card" data-room-status="{{ room.status }}" data-room-id="{{ room.room_id }}">
          <div class="card h-100 room-card room-{{ room.status|lower }} shadow-sm cursor-pointer" 
               onclick="showRoomDetails({{ room.room_id }})"
               title="Click to change status">
            
            <div class="card-header {% if room.status == 'Available' %}bg-success{% elif room.status == 'Booked' %}bg-warning{% else %}bg-danger{% endif %} text-white">
              <div class="d-flex justify-content-between align-items-center">
                <strong>Room {{ room.room_number }}</strong>
                <span class="badge bg-light text-dark" id="badge-{{ room.room_id }}">{{ room.status }}</span>
              </div>
            </div>

            <div class="card-body p-2">
              
              <!-- Room Type -->
              <p class="mb-2">
                <small class="badge bg-info">{{ room.room_type }}</small>
              </p>

              <!-- Status Icon -->
              <div class="text-center mb-2" id="status-icon-{{ room.room_id }}">
                {% if room.status == 'Available' %}
                  <i class="fas fa-check-circle text-success" style="font-size: 2rem;"></i>
                {% elif room.status == 'Booked' %}
                  <i class="fas fa-door-closed text-warning" style="font-size: 2rem;"></i>
                {% elif room.status == 'Maintenance' %}
                  <i class="fas fa-tools text-danger" style="font-size: 2rem;"></i>
                {% endif %}
              </div>

              <!-- Guest Info (if booked) -->
              {% if room.guest_name %}
                <p class="small mb-1">
                  <strong>{{ room.guest_name }}</strong>
                </p>
                <p class="small text-muted mb-2">
                  <i class="fas fa-calendar"></i> Out: {{ room.checkout_date }}
                </p>
              {% endif %}

              <!-- Price -->
              <p class="text-center mb-0">
                <strong class="text-primary">₹{{ room.price_per_night }}/night</strong>
              </p>

            </div>

            <!-- Footer with Actions -->
            <div class="card-footer bg-light p-2" onclick="event.stopPropagation();">
              <div class="btn-group btn-group-sm w-100" role="group">
                <a href="/rooms/{{ room.room_id }}" class="btn btn-outline-primary" title="View Details">
                  <i class="fas fa-eye"></i>
                </a>
                <button type="button" class="btn btn-outline-secondary" onclick="quickToggleStatus({{ room.room_id }})" title="Toggle Status">
                  <i class="fas fa-exchange-alt"></i>
                </button>
              </div>
            </div>

          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="col-12">
        <div class="alert alert-info text-center">
          <i class="fas fa-inbox" style="font-size: 2rem; opacity: 0.3;"></i>
          <p class="mt-2 mb-0">No rooms found</p>
        </div>
      </div>
    {% endif %}
  </div>
</div>

<!-- Floor View -->
<div id="floorView" style="display: none;">
  <div class="card shadow mb-4">
    <div class="card-header">
      <h5 class="mb-0">Floor Map</h5>
    </div>
    <div class="card-body">
      <div id="floorMapContainer">
        <!-- Floor map will be generated here -->
      </div>
    </div>
  </div>
</div>

<!-- Table View -->
<div id="tableView" style="display: none;">
  <div class="card shadow">
    <div class="card-header">
      <h5 class="mb-0">Room Status Table</h5>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0" id="roomStatusTable">
          <thead class="table-light">
            <tr>
              <th>Room</th>
              <th>Type</th>
              <th>Status</th>
              <th>Current Guest</th>
              <th>Check-out</th>
              <th>Price</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for room in rooms %}
              <tr class="room-table-row" data-room-status="{{ room.status }}">
                <td><strong>{{ room.room_number }}</strong></td>
                <td>{{ room.room_type }}</td>
                <td>
                  {% if room.status == 'Available' %}
                    <span class="badge bg-success">Available</span>
                  {% elif room.status == 'Booked' %}
                    <span class="badge bg-warning text-dark">Booked</span>
                  {% elif room.status == 'Maintenance' %}
                    <span class="badge bg-danger">Maintenance</span>
                  {% endif %}
                </td>
                <td>
                  {% if room.guest_name %}
                    <a href="/guests/{{ room.guest_id }}">{{ room.guest_name }}</a>
                  {% else %}
                    <span class="text-muted">--</span>
                  {% endif %}
                </td>
                <td>
                  {% if room.checkout_date %}
                    {{ room.checkout_date }}
                  {% else %}
                    <span class="text-muted">--</span>
                  {% endif %}
                </td>
                <td>₹{{ room.price_per_night }}</td>
                <td>
                  <div class="btn-group btn-group-sm" role="group">
                    <a href="/rooms/{{ room.room_id }}" class="btn btn-outline-primary">
                      <i class="fas fa-eye"></i> View
                    </a>
                    <button type="button" class="btn btn-outline-secondary" onclick="quickToggleStatus({{ room.room_id }})">
                      <i class="fas fa-exchange-alt"></i> Toggle
                    </button>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Status Change Modal -->
<div class="modal fade" id="statusModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Change Room Status</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Room: <strong id="modalRoomNumber"></strong></p>
        <p>Current Status: <span id="modalCurrentStatus" class="badge"></span></p>
        <div class="mt-3">
          <label class="form-label">Select New Status:</label>
          <div class="d-flex gap-2">
            <button class="btn btn-success flex-grow-1" onclick="updateRoomStatus('Available')">
              <i class="fas fa-check-circle"></i> Available
            </button>
            <button class="btn btn-warning flex-grow-1" onclick="updateRoomStatus('Booked')">
              <i class="fas fa-door-closed"></i> Booked
            </button>
            <button class="btn btn-danger flex-grow-1" onclick="updateRoomStatus('Maintenance')">
              <i class="fas fa-tools"></i> Maintenance
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Legend & Export -->
<div class="row mt-4">
  <div class="col-md-6">
    <div class="card shadow">
      <div class="card-header">
        <h6 class="mb-0">Status Legend</h6>
      </div>
      <div class="card-body">
        <div class="d-flex align-items-center mb-2">
          <span class="badge bg-success me-2" style="width: 30px; height: 30px;"></span>
          <span>Available - Room is ready for new bookings</span>
        </div>
        <div class="d-flex align-items-center mb-2">
          <span class="badge bg-warning me-2" style="width: 30px; height: 30px;"></span>
          <span>Booked - Room is currently occupied</span>
        </div>
        <div class="d-flex align-items-center">
          <span class="badge bg-danger me-2" style="width: 30px; height: 30px;"></span>
          <span>Maintenance - Room is under maintenance</span>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card shadow">
      <div class="card-header">
        <h6 class="mb-0">Reports & Export</h6>
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <button class="btn btn-outline-primary" onclick="exportReport()">
            <i class="fas fa-download"></i> Export Status Report (CSV)
          </button>
          <button class="btn btn-outline-secondary" onclick="printReport()">
            <i class="fas fa-print"></i> Print Room Status
          </button>
          <button class="btn btn-outline-info" onclick="autoRefresh()">
            <i class="fas fa-sync-alt"></i> Auto Refresh
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  let currentRoomId = null;
  let autoRefreshInterval = null;
  let currentViewMode = 'grid';

  // Filter status
  function filterStatus(status) {
    // Update button states
    document.querySelectorAll('[id^="filter"]').forEach(btn => btn.classList.remove('active'));
    if (status === 'all') {
      document.getElementById('filterAll').classList.add('active');
      document.querySelectorAll('[data-room-status]').forEach(card => card.style.display = '');
    } else {
      document.getElementById('filter' + status).classList.add('active');
      document.querySelectorAll('[data-room-status]').forEach(card => {
        card.style.display = card.dataset.roomStatus === status ? '' : 'none';
      });
    }
  }

  // Set view mode
  function setViewMode(mode) {
    currentViewMode = mode;
    
    // Update button states
    event.target.parentElement.querySelectorAll('.btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');

    // Show/hide views
    document.getElementById('gridView').style.display = mode === 'grid' ? '' : 'none';
    document.getElementById('floorView').style.display = mode === 'floor' ? '' : 'none';
    document.getElementById('tableView').style.display = mode === 'table' ? '' : 'none';

    if (mode === 'floor') {
      generateFloorMap();
    }
  }

  // Show room details in modal
  function showRoomDetails(roomId) {
    currentRoomId = roomId;
    const roomCard = document.querySelector(`[data-room-id="${roomId}"]`);
    const roomNumber = roomCard.querySelector('strong').textContent;
    const roomStatus = roomCard.dataset.roomStatus;

    document.getElementById('modalRoomNumber').textContent = roomNumber;
    document.getElementById('modalCurrentStatus').textContent = roomStatus;
    document.getElementById('modalCurrentStatus').className = 
      'badge ' + (roomStatus === 'Available' ? 'bg-success' : 
                   roomStatus === 'Booked' ? 'bg-warning text-dark' : 'bg-danger');

    new bootstrap.Modal(document.getElementById('statusModal')).show();
  }

  // Quick toggle status
  function quickToggleStatus(roomId) {
    const roomCard = document.querySelector(`[data-room-id="${roomId}"]`);
    const currentStatus = roomCard.dataset.roomStatus;
    let newStatus;

    if (currentStatus === 'Available') {
      newStatus = 'Booked';
    } else if (currentStatus === 'Booked') {
      newStatus = 'Maintenance';
    } else {
      newStatus = 'Available';
    }

    updateRoomStatusDirect(roomId, newStatus);
  }

  // Update room status
  function updateRoomStatus(status) {
    if (currentRoomId) {
      updateRoomStatusDirect(currentRoomId, status);
      bootstrap.Modal.getInstance(document.getElementById('statusModal')).hide();
    }
  }

  // Update room status (direct API call)
  function updateRoomStatusDirect(roomId, status) {
    fetch(`/api/rooms/${roomId}/status`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ status: status })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Update card visually
        const roomCard = document.querySelector(`[data-room-id="${roomId}"]`);
        roomCard.dataset.roomStatus = status;
        
        // Update header color
        const header = roomCard.querySelector('.card-header');
        header.className = 'card-header ' + 
          (status === 'Available' ? 'bg-success' : 
           status === 'Booked' ? 'bg-warning' : 'bg-danger') + ' text-white';
        
        // Update badge
        roomCard.querySelector('.badge').textContent = status;
        
        // Update icon
        const icon = roomCard.querySelector('[id^="status-icon"]');
        if (icon) {
          if (status === 'Available') {
            icon.innerHTML = '<i class="fas fa-check-circle text-success" style="font-size: 2rem;"></i>';
          } else if (status === 'Booked') {
            icon.innerHTML = '<i class="fas fa-door-closed text-warning" style="font-size: 2rem;"></i>';
          } else {
            icon.innerHTML = '<i class="fas fa-tools text-danger" style="font-size: 2rem;"></i>';
          }
        }
        
        alert('Room status updated successfully');
      } else {
        alert('Error: ' + data.error);
      }
    })
    .catch(error => alert('Error: ' + error));
  }

  // Generate floor map
  function generateFloorMap() {
    const container = document.getElementById('floorMapContainer');
    if (container.innerHTML.trim() === '') {
      // Generate simple floor representation
      const rooms = document.querySelectorAll('[data-room-id]');
      let floorHtml = '<div class="d-flex flex-wrap gap-2">';
      rooms.forEach(room => {
        const roomId = room.dataset.roomId;
        const roomNumber = room.querySelector('strong').textContent;
        const status = room.dataset.roomStatus;
        const color = status === 'Available' ? 'success' : status === 'Booked' ? 'warning' : 'danger';
        
        floorHtml += `
          <div class="badge bg-${color} p-3" style="width: 80px; height: 60px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; cursor: pointer;" onclick="showRoomDetails(${roomId})">
            ${roomNumber}
          </div>
        `;
      });
      floorHtml += '</div>';
      container.innerHTML = floorHtml;
    }
  }

  // Export report
  function exportReport() {
    const rooms = document.querySelectorAll('[data-room-id]');
    let csv = 'Room Number,Type,Status,Guest,Price\n';
    
    rooms.forEach(room => {
      const roomNumber = room.querySelector('strong').textContent.replace('Room ', '');
      const type = room.querySelector('.badge.bg-info')?.textContent || 'N/A';
      const status = room.dataset.roomStatus;
      const guest = room.querySelector('strong')?.nextElementSibling?.textContent || '--';
      const price = room.querySelector('.text-primary')?.textContent.split('/')[0] || '0';
      
      csv += `"${roomNumber}","${type}","${status}","${guest}","${price}"\n`;
    });

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `room_status_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
  }

  // Print report
  function printReport() {
    window.print();
  }

  // Auto refresh
  function autoRefresh() {
    if (autoRefreshInterval) {
      clearInterval(autoRefreshInterval);
      autoRefreshInterval = null;
      alert('Auto refresh stopped');
    } else {
      autoRefreshInterval = setInterval(() => {
        location.reload();
      }, 30000); // Refresh every 30 seconds
      alert('Auto refresh enabled (every 30 seconds)');
    }
  }

  // Add CSS styling
  const style = document.createElement('style');
  style.textContent = `
    .room-card {
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
    }
    .room-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15) !important;
    }
    .room-available { border-left: 5px solid #28a745; }
    .room-booked { border-left: 5px solid #ffc107; }
    .room-maintenance { border-left: 5px solid #dc3545; }
    @media print {
      .btn, nav, .breadcrumb, [id^="filter"], [role="group"] {
        display: none !important;
      }
    }
  `;
  document.head.appendChild(style);
</script>
{% endblock %}
